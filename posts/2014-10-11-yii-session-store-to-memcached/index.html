<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Yii在Web分布式下将Session存储到Memcached - Du, Chengbin's Blog</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta itemprop=name content="Yii在Web分布式下将Session存储到Memcached">
<meta itemprop=description content="当网站的访问越来越大的时候一台机器无法支持迸发，或都是为了做到去单点，都需要在后端搭建一个集群来处理用户的请求，由于传统的PHP Session是文件级的存储，那么如果一个用户在第一次登录的时候这个Session文件存在 A 服务器上，而第二次的时候被分到了B 服务器上，则又认为他没有登录了（当然配置好负载均衡的是可以让同一个用户永远在同一台机器上的，这个的可以略过。。。），所以我们需要将它存在一个别的地方，我选的是Memcached，存在这里面，当然后期可能会选择Redis因为它在取值方面可以更精确，省内网带宽。"><meta itemprop=datePublished content="2014-10-11T00:00:00+08:00">
<meta itemprop=dateModified content="2014-10-11T00:00:00+08:00">
<meta itemprop=wordCount content="115">
<meta itemprop=keywords content="Yii,Memcached,"><meta property="og:title" content="Yii在Web分布式下将Session存储到Memcached">
<meta property="og:description" content="当网站的访问越来越大的时候一台机器无法支持迸发，或都是为了做到去单点，都需要在后端搭建一个集群来处理用户的请求，由于传统的PHP Session是文件级的存储，那么如果一个用户在第一次登录的时候这个Session文件存在 A 服务器上，而第二次的时候被分到了B 服务器上，则又认为他没有登录了（当然配置好负载均衡的是可以让同一个用户永远在同一台机器上的，这个的可以略过。。。），所以我们需要将它存在一个别的地方，我选的是Memcached，存在这里面，当然后期可能会选择Redis因为它在取值方面可以更精确，省内网带宽。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://dcb9.github.io/posts/2014-10-11-yii-session-store-to-memcached/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2014-10-11T00:00:00+08:00">
<meta property="article:modified_time" content="2014-10-11T00:00:00+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Yii在Web分布式下将Session存储到Memcached">
<meta name=twitter:description content="当网站的访问越来越大的时候一台机器无法支持迸发，或都是为了做到去单点，都需要在后端搭建一个集群来处理用户的请求，由于传统的PHP Session是文件级的存储，那么如果一个用户在第一次登录的时候这个Session文件存在 A 服务器上，而第二次的时候被分到了B 服务器上，则又认为他没有登录了（当然配置好负载均衡的是可以让同一个用户永远在同一台机器上的，这个的可以略过。。。），所以我们需要将它存在一个别的地方，我选的是Memcached，存在这里面，当然后期可能会选择Redis因为它在取值方面可以更精确，省内网带宽。">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css>
<link rel=stylesheet type=text/css media=screen href=https://dcb9.github.io/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://dcb9.github.io/css/main.css>
<link rel=stylesheet type=text/css href=https://dcb9.github.io/css/katex.min.css>
<link id=dark-scheme rel=stylesheet type=text/css href=https://dcb9.github.io/css/dark.css>
<script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<script src=https://dcb9.github.io/js/main.js></script><script src=https://dcb9.github.io/js/katex.min.js></script><script src=https://dcb9.github.io/js/auto-render.min.js></script><script src=https://dcb9.github.io/js/custom.js></script>
</head>
<body>
<div class="container wrapper">
<div class=header>
<h1 class=site-title><a href=https://dcb9.github.io/>Du, Chengbin's Blog</a></h1>
<div class=site-description><p>A software engineer</p><nav class="nav social">
<ul class=flat><li><a href=https://github.com/dcb9 title=Github><i data-feather=github></i></a></li><li><a href=https://twitter.com/robertduu title=Twitter><i data-feather=twitter></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li></ul>
</nav>
</div>
<nav class=nav>
<ul class=flat>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/posts>All posts</a>
</li>
<li>
<a href=/about>About</a>
</li>
<li>
<a href=/tags>Tags</a>
</li>
</ul>
</nav>
</div>
<div class=post>
<div class=post-header>
<div class=meta>
<div class=date>
<span class=day>11</span>
<span class=rest>Oct 2014</span>
</div>
</div>
<div class=matter>
<h1 class=title>Yii在Web分布式下将Session存储到Memcached</h1>
</div>
</div>
<div class=markdown>
<p>当网站的访问越来越大的时候一台机器无法支持迸发，或都是为了做到去单点，都需要在后端搭建一个集群来处理用户的请求，由于传统的PHP Session是文件级的存储，那么如果一个用户在第一次登录的时候这个Session文件存在 A 服务器上，而第二次的时候被分到了B 服务器上，则又认为他没有登录了（当然配置好负载均衡的是可以让同一个用户永远在同一台机器上的，这个的可以略过。。。），所以我们需要将它存在一个别的地方，我选的是Memcached，存在这里面，当然后期可能会选择Redis因为它在取值方面可以更精确，省内网带宽。</p>
<p>在Yii里面我想达到将Session信息存储到Memcached里面只需要稍做配置即可，我当前的Yii版本为yii-1.1.13.e9e4a0</p>
<h3 id=修改componets配置文件>修改componets配置文件</h3>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#a31515>&#39;session&#39;</span> =&gt; array(
    <span style=color:#a31515>&#39;class&#39;</span> =&gt; <span style=color:#a31515>&#39;CCacheHttpSession&#39;</span>,
    <span style=color:#a31515>&#39;autoStart&#39;</span> =&gt; true,
    <span style=color:#a31515>&#39;cacheID&#39;</span> =&gt; <span style=color:#a31515>&#39;sessionCache&#39;</span>, // we only use the sessionCache to store the session
    <span style=color:#a31515>&#39;cookieMode&#39;</span> =&gt; <span style=color:#a31515>&#39;only&#39;</span>,
    <span style=color:#a31515>&#39;timeout&#39;</span> =&gt; 1400,
),
<span style=color:#a31515>&#39;sessionCache&#39;</span> =&gt; array(
    <span style=color:#a31515>&#39;class&#39;</span> =&gt; <span style=color:#a31515>&#39;system.caching.CMemCache&#39;</span>,
    <span style=color:#a31515>&#39;servers&#39;</span> =&gt; array(
        array( <span style=color:#a31515>&#39;host&#39;</span> =&gt; <span style=color:#a31515>&#39;192.168.10.193&#39;</span>, <span style=color:#a31515>&#39;port&#39;</span> =&gt; 11211, <span style=color:#a31515>&#39;weight&#39;</span> =&gt; 6),
        array( <span style=color:#a31515>&#39;host&#39;</span> =&gt; <span style=color:#a31515>&#39;192.168.10.226&#39;</span>, <span style=color:#a31515>&#39;port&#39;</span> =&gt; 11211, <span style=color:#a31515>&#39;weight&#39;</span> =&gt; 3),
        array( <span style=color:#a31515>&#39;host&#39;</span> =&gt; <span style=color:#a31515>&#39;192.168.10.228&#39;</span>, <span style=color:#a31515>&#39;port&#39;</span> =&gt; 11211, <span style=color:#a31515>&#39;weight&#39;</span> =&gt; 2),
    ),
),
</code></pre></div><p>测试一下登录没有问题，然后非常好奇，它真的就存入到Memcached里面了吗？我们如何来验证一下呢？
为了省去新建一个Controller所以我就直接写一个action到SiteController里面去了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#00f>public</span> <span style=color:#00f>function</span> actionTestSessionWithMemcached(){

    <span style=color:green>/*
</span><span style=color:green>     * 得到sessionID号
</span><span style=color:green>     * 计算出来存在memcached的key值是多少.
</span><span style=color:green>     */</span>
    $sessionId = Yii::app()-&gt;session-&gt;sessionID;
    <span style=color:#00f>echo</span> <span style=color:#a31515>&#34;key:&#34;</span>, $key = CCacheHttpSession::CACHE_KEY_PREFIX.$sessionId;

    <span style=color:#a31515>/**
</span><span style=color:#a31515>     * 这相当于是直接使用Memcached 连接，和session没有任何挂钩，
</span><span style=color:#a31515>     * 我们来看一下session的数据是否真的就存在了memcached里边。
</span><span style=color:#a31515>     * 通过计算出来的key直接用 get命令获取然后将数据打印出来就能看到值了。
</span><span style=color:#a31515>     * 测试的时候先登录噢，别不登录就开始测试估计会获取不到值，以为有问题呢！
</span><span style=color:#a31515>     */</span>
    $mem =  Yii::app()-&gt;sessionCache;
    $data =$mem-&gt;get($key);
    var_dump($data);
}
</code></pre></div>
</div>
<div class=tags>
<ul class=flat>
<li><a href=/tags/yii>Yii</a></li>
<li><a href=/tags/memcached>Memcached</a></li>
</ul>
</div></div>
</div>
<div class="footer wrapper">
<nav class=nav>
<div>2022 © Copyright Du, Chengbin | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div>
</nav>
</div>
<script>feather.replace()</script>
</body>
</html>