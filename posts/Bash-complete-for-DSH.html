<!doctype html>
<html lang="en"> <head> <title>Chengbin Du&#039;s Blog</title> <meta http-equiv="content-type" content="text/html;" charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link href="//fonts.googleapis.com/css?family=Vollkorn:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" /> <link href="//fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /> <link href= "https://dcb9.github.io/css/style.css" rel="stylesheet" type="text/css" /> <link rel="alternate" href="https://dcb9.github.io/rss.xml" type="application/rss+xml" />  </head> <body> <div class="navigation"> <a href="https://dcb9.github.io">Chengbin Du&#039;s Blog</a> | <a href="/">Home</a>  | <a href="http://github.com/dcb9">GitHub</a>  | <a href="https://twitter.com/robertduu">Twitter</a>  </div> <div id="content"> <div class="article-meta">
<h1 class="title">Bash complete for DSH</h1>
<div class="tags">
Tagged as <a href="https://dcb9.github.io/tag/shell.html">shell</a> </div>
<div class="date">
Written on 2014-09-08 </div>
</div>
<div class="article-content">
<p>我们有许多的服务器需要管理，所以就会使用到一个软件 dsh 来批量操作多台机器。默认是这样子的 # dsh 各种参数加选项（但其实我们用的参数和选项的值永远都是那几个，连位置都不变 ） 指定组名  &quot;需要执行的命令&quot;，由于组名是定义在 /etc/dsh/group 目录下面的，所以在默认的 bash shell 里面，当我想让它自动补全组名的时候是不可以的。</p>

<h3>目标</h3>

<ol>
<li>使用 DSH 这个命令来控制多台服务器</li>
<li>在使用 DSH 的时候，组名如果能够自动补全就好了（因为我在/etc/dsh/group/ 下有 groupA groupB groupC）</li>
</ol>

<h3>实现思路</h3>

<ol>
<li>dsh 使用的远程 shell 为 bash shell （其它的 shell 没玩过）</li>
<li>在连接机器的时候如果这台机器未在 .ssh/known_hosts 里面，希望系统能够自动输入 yes 不然太麻烦啦！</li>
<li>通过 Bash shell 的 complete 来实现自定义tab键补全的功能</li>
</ol>

<h3>实现步骤</h3>

<p>创建一个替代默认的 dsh 的脚本，放到 /usr/local/bin/ 目录下</p>

<pre><code># file: dsh.sh

GROUP=&quot;$1&quot;
COMMAND=&quot;$2&quot;
dsh -o '-o StrictHostKeyChecking=no' -c  -M -g &quot;$GROUP&quot;&quot;$COMMAND&quot;  # 这些参数我们使用的时候都是不变的
</code></pre>

<p>为这个脚本创建 <tab> 键补全的 complete 程序
这个程序也放在 /usr/local/bin/ 目录下，这样方便以后的查看，或另一个人也能明白这个是干嘛的</p>

<pre><code># file: dsh.sh-complete 
# dsh.sh parameter-completion
_UseDsh.sh ()   #  By convention, the function name
{                 #+ starts with an underscore.
  local cur
  # Pointer to current completion word.
  # By convention, it's named &quot;cur&quot; but this isn't strictly necessary.
  COMPREPLY=()   # Array variable storing the possible completions.
  cur=${COMP_WORDS[COMP_CWORD]}
  case &quot;$cur&quot; in
    *)
      COMPREPLY=( $( compgen -W '`cd /etc/dsh/group ; ls $cur* 2&amp;gt; /dev/null`' ) );;
  esac
  return 0
}
complete -F _UseDsh.sh dsh.sh
</code></pre>

<p>在用户登录到这台机器的时候自动 source 这一个为 dsh.sh 的 complete 的程序。</p>

<pre><code># echo &quot;source /usr/local/bin/dsh.sh-complete&quot;&gt;&gt;/etc/bash/bashrc
</code></pre>

<h3>测试</h3>

<pre><code># dsh.sh&lt;tab&gt;&lt;tab&gt; （就能自动补全以下的组）
number26PhysicalServers number27PhysicalServers
最终运行的命令为：
查看这个组下面的机器的内核版本
# dsh.sh number26PhysicalServers &quot;uname -a&quot;
</code></pre>

<h3>说明</h3>

<ul>
<li>number26PhysicalServers number27PhysicalServers 这两个组是我事先创建好的。</li>
<li>我这个说的是 dsh 加上 bash shell complete 的应用，如果对这两个不懂需要了解这相关的知识</li>
<li>关于 bash shell complete 的两个文章链接，写的非常简洁易懂，建议需要的话仔细阅读，将会受益匪浅：<a href="http://tldp.org/LDP/abs/html/tabexpansion.html" >《Appendix J. An Introduction to Programmable Completion》</a>、<a href="http://www.debian-administration.org/article/316/An_introduction_to_bash_completion_part_1" >《An introduction to bash completion》</a></li>
</ul>
 </div>
<div class="relative-nav">
<a href="https://dcb9.github.io/posts/What-did-i-do-for-my-company-in-2013.html">Previous</a><br>
<a href="https://dcb9.github.io/posts/PHP-MyAdmin-改造实现单点登录.html">Next</a><br>
</div>
 </div>  <div class="fineprint"> <hr> Unless otherwise credited all material <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"> <img alt="Creative Commons License" style="border-width:0" src="https://dcb9.github.io/css/cc-by-sa.png" /> </a> by Chengbin Du <a id="coleslaw-logo" href="https://github.com/redline6561/coleslaw"> <img src="https://dcb9.github.io/css/logo_small.jpg" alt="Coleslaw logo" /> </a> </div> </body> </html>