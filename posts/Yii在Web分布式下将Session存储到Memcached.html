<!doctype html>
<html lang="en"> <head> <title>Du, Chengbin&#039;s Blog</title> <meta http-equiv="content-type" content="text/html;" charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link href="//fonts.googleapis.com/css?family=Vollkorn:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" /> <link href="//fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /> <link href= "https://dcb9.github.io/css/style.css" rel="stylesheet" type="text/css" /> <link rel="alternate" href="https://dcb9.github.io/rss.xml" type="application/rss+xml" />  </head> <body> <div class="navigation"> <a href="https://dcb9.github.io">Du, Chengbin&#039;s Blog</a> | <a href="/">Home</a>  | <a href="http://github.com/dcb9">GitHub</a>  | <a href="https://twitter.com/robertduu">Twitter</a>  </div> <div id="content"> <div class="article-meta">
<h1 class="title">Yii在Web分布式下将Session存储到Memcached</h1>
<div class="tags">
Tagged as <a href="https://dcb9.github.io/tag/yii.html">yii</a>, <a href="https://dcb9.github.io/tag/memcached.html">memcached</a>, <a href="https://dcb9.github.io/tag/session.html">session</a> </div>
<div class="date">
Written on 2014-10-11 </div>
</div>
<div class="article-content">
<p>当网站的访问越来越大的时候一台机器无法支持迸发，或都是为了做到去单点，都需要在后端搭建一个集群来处理用户的请求，由于传统的PHP Session是文件级的存储，那么如果一个用户在第一次登录的时候这个Session文件存在 A 服务器上，而第二次的时候被分到了B 服务器上，则又认为他没有登录了（当然配置好负载均衡的是可以让同一个用户永远在同一台机器上的，这个的可以略过。。。），所以我们需要将它存在一个别的地方，我选的是Memcached，存在这里面，当然后期可能会选择Redis因为它在取值方面可以更精确，省内网带宽。</p>

<p>在Yii里面我想达到将Session信息存储到Memcached里面只需要稍做配置即可，我当前的Yii版本为yii-1.1.13.e9e4a0</p>

<h3>修改componets配置文件</h3>

<pre><code>'session' =&gt; array(
    'class' =&gt; 'CCacheHttpSession',
    'autoStart' =&gt; true,
    'cacheID' =&gt; 'sessionCache', // we only use the sessionCache to store the session
    'cookieMode' =&gt; 'only',
    'timeout' =&gt; 1400,
),
'sessionCache' =&gt; array(
    'class' =&gt; 'system.caching.CMemCache',
    'servers' =&gt; array(
        array( 'host' =&gt; '192.168.10.193', 'port' =&gt; 11211, 'weight' =&gt; 6),
        array( 'host' =&gt; '192.168.10.226', 'port' =&gt; 11211, 'weight' =&gt; 3),
        array( 'host' =&gt; '192.168.10.228', 'port' =&gt; 11211, 'weight' =&gt; 2),
    ),
),
</code></pre>

<p>测试一下登录没有问题，然后非常好奇，它真的就存入到Memcached里面了吗？我们如何来验证一下呢？
为了省去新建一个Controller所以我就直接写一个action到SiteController里面去了。</p>

<pre><code>public function actionTestSessionWithMemcached(){

    /*
     * 得到sessionID号
     * 计算出来存在memcached的key值是多少.
     */
    $sessionId = Yii::app()-&gt;session-&gt;sessionID;
    echo &quot;key:&quot;, $key = CCacheHttpSession::CACHE_KEY_PREFIX.$sessionId;

    /**
     * 这相当于是直接使用Memcached 连接，和session没有任何挂钩，
     * 我们来看一下session的数据是否真的就存在了memcached里边。
     * 通过计算出来的key直接用 get命令获取然后将数据打印出来就能看到值了。
     * 测试的时候先登录噢，别不登录就开始测试估计会获取不到值，以为有问题呢！
     */
    $mem =  Yii::app()-&gt;sessionCache;
    $data =$mem-&gt;get($key);
    var_dump($data);
}
</code></pre>
 </div>
<div class="relative-nav">
<a href="https://dcb9.github.io/posts/Bash-shock-安全漏洞.html">Previous</a><br>
<a href="https://dcb9.github.io/posts/local-development-environment----Vagrant.html">Next</a><br>
</div>
 </div>  <div class="fineprint"> <hr> Unless otherwise credited all material <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"> <img alt="Creative Commons License" style="border-width:0" src="https://dcb9.github.io/css/cc-by-sa.png" /> </a> by Du, Chengbin <a id="coleslaw-logo" href="https://github.com/redline6561/coleslaw"> <img src="https://dcb9.github.io/css/logo_small.jpg" alt="Coleslaw logo" /> </a> </div> </body> </html>